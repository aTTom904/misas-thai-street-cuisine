
@using OneOf.Types
@using misas_thai_street_cuisine_2._0.Components
@using Microsoft.AspNetCore.Components.Forms
@inject misas_thai_street_cuisine_2._0.Services.OrderContextService OrderContext
@inject misas_thai_street_cuisine_2._0.Services.DeliveryValidationService DeliveryValidation

<div class="delivery-area-section">
    <div class="delivery-area-columns">
        <div class="delivery-area-map-col">
            <GoogleMap Latitude="@MapLat" Longitude="@MapLng" Zoom="12" MapId="@MapId" />
        </div>
        <div class="delivery-area-form-col">
            <h2 class="delivery-title">Delivery Areas</h2>
            <p class="delivery-desc">
                Enter your address to see if you qualify for free delivery. We’re currently serving select areas in St. Johns, FL — and expanding soon based on demand!
            </p>
            <EditForm Model="this" OnValidSubmit="OnSubmit">
                <div class="delivery-form-row">
                    <InputText id="street" name="street" class="delivery-input" @bind-Value="Street" placeholder="Street Address" @oninput="OnInputChanged" />
                    <InputText id="city" name="city" class="delivery-input" @bind-Value="City" placeholder="City" @oninput="OnInputChanged" />
                    <div class="delivery-state-zip-row">
                        <InputSelect id="state" name="state" class="delivery-input" @bind-Value="State" @onchange="OnInputChanged">
                            <option value="Florida">Florida</option>
                        </InputSelect>
                        <InputText id="zipcode" name="zipcode" class="delivery-input" @bind-Value="ZipCode" placeholder="Zip Code" @oninput="OnInputChanged" />
                    </div>
                </div>
                <div class="delivery-submit-row">
                    <button type="submit" class="delivery-submit">Submit</button>
                </div>
            </EditForm>
            @if (!string.IsNullOrEmpty(ResultMessage))
            {
                <div class="delivery-result @ResultType">@ResultMessage</div>
            }
        </div>
    </div>
    <p class="delivery-note">
        We love sharing our food far and wide, but for now we're keeping deliveries local to ensure everything arrives piping hot.
    </p>
</div>

@code {
    public string Street { get; set; } = string.Empty;
    public string City { get; set; } = string.Empty;
    public string State { get; set; } = "Florida";
    public string ZipCode { get; set; } = string.Empty;
    public string? ResultMessage { get; set; }
    public string? ResultType { get; set; } = "success";
    public double MapLat { get; set; } = 30.076059;
    public double MapLng { get; set; } = -81.5563301;
    private readonly string MapId = "google-map-main";

    private async Task OnInputChanged(ChangeEventArgs e)
    {
        var userAddress = $"{Street}, {City}, {State} {ZipCode}";
        var userLocation = await JS.InvokeAsync<LatLngResult>("geocodeAddress", userAddress);
        if (userLocation != null)
        {
            MapLat = userLocation.lat;
            MapLng = userLocation.lng;
        }
    }

    public class LatLngResult
    {
        public double lat { get; set; }
        public double lng { get; set; }
    }

    [Inject] private IJSRuntime JS { get; set; } = default!;

    private async Task OnSubmit()
    {
        var userAddress = $"{Street}, {City}, {State} {ZipCode}";
        OrderContext.Address = userAddress;
        
        // Use the shared delivery validation service
        var result = await DeliveryValidation.ValidateDeliveryAddress(userAddress);
        
        ResultType = result.ResultType;
        ResultMessage = result.Message;
    }
}