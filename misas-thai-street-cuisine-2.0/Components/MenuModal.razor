@using misas_thai_street_cuisine_2._0.Models

@inject ShoppingCartService Cart

<div class="menu-modal-overlay" @onclick="OnOverlayClick">
    <div class="menu-modal" @onclick:stopPropagation>
        <button class="menu-modal-close" @onclick="OnClose">&times;</button>
        @if (MenuItem != null)
        {
            <div class="menu-modal-img-block">
                <img src="@MenuItem.ImageUrl" alt="@MenuItem.Name" class="menu-modal-img" />
            </div>
            <div class="menu-modal-content">

                <h2 class="menu-modal-title">@MenuItem.Name</h2>
                <div class="menu-modal-desc">@MenuItem.Description</div>
                @if (MenuItem is Platter platter)
                {
                    <div class="menu-modal-price">
                        @foreach (var serve in platter.Serves)
                        {
                            <div>
                                <b>Serves @serve:</b> $@platter.Prices[serve]
                            </div>
                        }
                    </div>
                    <div class="modal-cart-section">
                        @foreach (var serve in platter.Serves)
                        {
                            <div class="cart-row">
                                <span class="cart-label">Serves @serve</span>
                                <span class="cart-price">$@platter.Prices[serve]</span>
                                <button class="cart-btn" @onclick="() => ChangePlatterQty(serve, -1)">−</button>
                                <span class="cart-qty">@GetPlatterQty(serve)</span>
                                <button class="cart-btn" @onclick="() => ChangePlatterQty(serve, 1)">+</button>
                            </div>
                            @if (serve == 2 && GetPlatterQty(2) > 0)
                            {
                                <div class="cart-upgrade-row slide-in">
                                    <div class="cart-upgrade-option">
                                        <span class="cart-upgrade-label"><b>Upgrade:</b> Swap sticky rice for 24 oz Phad Thai – <b>add $9</b></span>
                                        <button class="cart-btn" @onclick="() => ChangePhadThai24(-1)">−</button>
                                        <span class="cart-qty">@PhadThai24Qty</span>
                                        <button class="cart-btn" @onclick="() => ChangePhadThai24(1)">+</button>
                                    </div>
                                </div>
                            }
                            @if (serve == 4 && GetPlatterQty(4) > 0)
                            {
                                <div class="cart-upgrade-row slide-in">
                                    <div class="cart-upgrade-option">
                                        <span class="cart-upgrade-label"><b>Upgrade:</b> Swap sticky rice for 48 oz Phad Thai – <b>add $18</b></span>
                                        <button class="cart-btn" @onclick="() => ChangePhadThai48(-1)">−</button>
                                        <span class="cart-qty">@PhadThai48Qty</span>
                                        <button class="cart-btn" @onclick="() => ChangePhadThai48(1)">+</button>
                                    </div>
                                </div>
                            }
                        }
                        <!-- Cart is updated automatically on every change -->
                    </div>
                }
                else if (MenuItem is SideDish side)
                {
                    <div class="menu-modal-price">$@side.Price</div>
                    <div class="modal-cart-section">
                        <div class="cart-row">
                            <span class="cart-label">@side.Name</span>
                            <span class="cart-price">$@side.Price</span>
                            <button class="cart-btn" @onclick="() => ChangeSideQty(-1)">−</button>
                            <span class="cart-qty">@SideQty</span>
                            <button class="cart-btn" @onclick="() => ChangeSideQty(1)">+</button>
                        </div>
                    </div>
                }

                @if (MenuItem is Platter platter2)
                {
                
                }
                @ChildContent
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public MenuItem? MenuItem { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public RenderFragment? ChildContent { get; set; }
    private Dictionary<int, int> PlatterQty = new Dictionary<int, int> { { 2, 0 }, { 4, 0 } };
    private int PhadThai24Qty = 0;
    private int PhadThai48Qty = 0;
    private int SideQty = 0;

    protected override void OnParametersSet()
    {
        if (MenuItem is Platter platter)
        {
            // Reset
            PlatterQty[2] = 0;
            PlatterQty[4] = 0;
            PhadThai24Qty = 0;
            PhadThai48Qty = 0;
            // Check cart for each serve
            foreach (var serve in platter.Serves)
            {
                var match = Cart.Items.FirstOrDefault(i =>
                    i.Item.Name == platter.Name &&
                    i.SelectedServes == serve);
                if (match != null)
                {
                    PlatterQty[serve] = match.Quantity;
                    if (serve == 2) PhadThai24Qty = match.UpgradePhadThai24Qty;
                    if (serve == 4) PhadThai48Qty = match.UpgradePhadThai48Qty;
                }
            }
        }
        else if (MenuItem is SideDish side)
        {
            var match = Cart.Items.FirstOrDefault(i => i.Item.Name == side.Name);
            SideQty = match?.Quantity ?? 0;
        }
    }

    private void OnOverlayClick()
    {
        OnClose.InvokeAsync();
    }

    private void ChangeSideQty(int delta)
    {
        SideQty = Math.Max(0, SideQty + delta);
        UpdateSideInCart();
    }

    private void ChangePlatterQty(int serves, int delta)
    {
        if (!PlatterQty.ContainsKey(serves))
            PlatterQty[serves] = 0;
        PlatterQty[serves] = Math.Max(0, PlatterQty[serves] + delta);
        // Clamp upgrades to parent qty
        if (serves == 2) PhadThai24Qty = Math.Min(PhadThai24Qty, PlatterQty[2]);
        if (serves == 4) PhadThai48Qty = Math.Min(PhadThai48Qty, PlatterQty[4]);
        // If parent qty is zero, reset upgrades
        if (serves == 2 && PlatterQty[2] == 0) PhadThai24Qty = 0;
        if (serves == 4 && PlatterQty[4] == 0) PhadThai48Qty = 0;
        UpdatePlatterInCart(serves);
    }

    private int GetPlatterQty(int serves)
    {
        return PlatterQty.ContainsKey(serves) ? PlatterQty[serves] : 0;
    }

    private void ChangePhadThai24(int delta)
    {
        int parentQty = GetPlatterQty(2);
        if (parentQty > 0)
        {
            PhadThai24Qty = Math.Max(0, Math.Min(parentQty, PhadThai24Qty + delta));
            UpdatePlatterInCart(2);
        }
    }
    private void ChangePhadThai48(int delta)
    {
        int parentQty = GetPlatterQty(4);
        if (parentQty > 0)
        {
            PhadThai48Qty = Math.Max(0, Math.Min(parentQty, PhadThai48Qty + delta));
            UpdatePlatterInCart(4);
        }
    }
    // Update or remove platter in cart for a given serve size
    private void UpdatePlatterInCart(int serves)
    {
        if (MenuItem is Platter platter)
        {
            var qty = GetPlatterQty(serves);
            int upgrade24 = (serves == 2) ? PhadThai24Qty : 0;
            int upgrade48 = (serves == 4) ? PhadThai48Qty : 0;
            // Always remove all CartItems for this platter/serve
            var matches = Cart.Items.Where(i =>
                i.Item.Name == platter.Name &&
                i.SelectedServes == serves).ToList();
            foreach (var match in matches)
            {
                Cart.RemoveItem(match);
            }
            // Add a single CartItem with current qty and upgrades if qty > 0
            if (qty > 0)
            {
                var cartItem = new CartItem(platter, qty, serves, upgrade24, upgrade48);
                Cart.AddItem(cartItem);
            }
        }
    }

    // Update or remove side dish in cart
    private void UpdateSideInCart()
    {
        if (MenuItem is SideDish side)
        {
            var match = Cart.Items.FirstOrDefault(i => i.Item.Name == side.Name);
            if (SideQty > 0)
            {
                Cart.AddItem(new CartItem(side, SideQty));
            }
            else if (match != null)
            {
                Cart.RemoveItem(match);
            }
        }
    }
}
